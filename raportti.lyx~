#LyX 2.1 created this file. For more info see http://www.lyx.org/
\lyxformat 474
\begin_document
\begin_header
\textclass article
\use_default_options true
\maintain_unincluded_children false
\language finnish
\language_package default
\inputencoding auto
\fontencoding global
\font_roman default
\font_sans default
\font_typewriter default
\font_math auto
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100
\font_tt_scale 100
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref false
\papersize default
\use_geometry false
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\quotes_language swedish
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
Tietokantojen perusteiden harjoitustyö: keskustelupalsta 
\begin_inset Newline newline
\end_inset

väliraportti
\end_layout

\begin_layout Author
Ryhmä AR: Aarne Rissanen (014732571)
\end_layout

\begin_layout Part*
\begin_inset Newpage newpage
\end_inset

Johdanto
\end_layout

\begin_layout Standard
Tämä väliraportti esittelee alkuaskeleet yksinkertaisen keskustelupalstan
 toteutukseen, sisältäen mm.
 keskeisten käsitteiden esittelyn, tietokantataulujen määrittelyt ja keskustelup
alstan tavanomaiseen käyttöön liittyvät tietokantakyselyt.
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout

\emph on
Huomautus: 
\emph default
Pitääkseni asiat ja raportin kielen yksinkertaisena, raportissa käytetään
 ilmaisuja kuten 
\begin_inset Quotes sld
\end_inset

viesti ei voi vastata useampaan keskustelunavaukseen
\begin_inset Quotes srd
\end_inset

, tai 
\begin_inset Quotes sld
\end_inset

jokaisella keskustelunavauksella on yksi aihealue
\begin_inset Quotes srd
\end_inset

.
 Näillä väittämillä tarkoitetaan, että asia on näin 
\emph on
tässä sovelluksessa, 
\emph default
ei välttämättä keskustelupalstoissa yleensä.
 Tämä ratkaisu toivottavasti välttää toistuvat 
\begin_inset Quotes sld
\end_inset

keskustelupalstan voisi myös toteuttaa niin, että...
\begin_inset Quotes srd
\end_inset

 -väittämät.
 Olen kuitenkin kommentoinut joissain tapauksissa vaihtoehtoisia ratkaisuja
 erikseen, mikäli tekemäni ratkaisu on ollut jotenkin poikkeuksellisen harkinnan
varainen.
\end_layout

\end_inset


\end_layout

\begin_layout Section
Keskeisimmät käsitteet
\end_layout

\begin_layout Subsection
Toteutuksen perustana käytettävät käsitteet
\end_layout

\begin_layout Standard
Tämä keskustelupalstan toteutus rakentuu seuraavaan kolmen käsitteen ympärille:
 
\emph on
aihealue, viesti 
\emph default
ja 
\emph on
keskustelunavaus
\emph default
:
\end_layout

\begin_layout Itemize

\emph on
Aihealue: 
\emph default
Yläkategoria, jonka alle keskustelunavaukset listataan.
 Jokainen keskustelunavaus lisätään tasan yhteen aihealueeseen, eli kyseessä
 on yhdestä-moneen yhteys.
 Tässä toteutuksessa vastaukset ovat yhteydessä suoraan vain keskustelunavauksee
n, joten erillistä yhteyttä aihealueen ja viestin välille ei tarvita.
 Keskeisiä aihealueen ominaisuuksia ovat aihealueen nimi, sille lisättyjen
 viestien määrä, ja viimeisimmän alueelle lisätyn viestin ajankohta.
 Lisäksi oletan (ainakin vielä), ettei peruskäyttäjän ole mahdollista lisätä
 uusia aihealueita, vaan että viisas palstan suunnittelija on valinnut osuvat
 ja keskustelua taidokkaasti rajaavat aihealueet.
 Lisäksi oletamn ainakin vielä tässä vaiheessa, että erillisiä ylä- ja ala-aihea
lueita ei ole, eli aihealueille ei tarvitse luoda omaa näiden keskenäistä
 rakennetta
\end_layout

\begin_layout Itemize

\emph on
Viesti: 
\emph default
Käyttäjän kirjoittama viesti, joka voi olla joko uusi keskustelunavaus tai
 vastaus aiempaan avaukseen.
 Joka tapauksessa jokainen viesti liittyy yhteen keskustelunavaukseen, ja
 keskustelunavaukseen voi liittyä useampi viesti, eli kyseessä on yhdestä
 moneen -yhteys.
 Viestistä on oleellista tietää ainakin sen kirjoituspäivämäärä, viestin
 kirjoittaja, viestin sisältö ja keskustelunavaus, johon viesti liittyy
\end_layout

\begin_layout Itemize

\emph on
Keskustelunavaus: 
\emph default
Keskustelunaihe, johon muut käyttäjät voivat lisätä vastauksiaan.
 Tässä sovelluksessa keskustelun avaaminen toteutuu niin, että kun käyttäjä
 lisää keskustelunavauksen kirjoittamalla viestin, niin luodaan sekä uusi
 keskustelunavaus että uusi viesti.
 Kuten aiemmin todettiin, keskustelunavaus on monesta yhteen -yhteydessä
 aihealueen kanssa ja yhdestä moneen -yhteydessä viestien kanssa.
 Keskustelunavauksista tulee ainakin tietää avauksen sisältö (eli otsikko),
 aihealue johon avaus kuuluu ja avauksen kirjoittaja.
\end_layout

\begin_layout Subsection
Käsitteet, joita ei valittu lopulliseen toteutukseen
\end_layout

\begin_layout Standard
Tässä esitellään muutama käsite, jotka oltaisiin voitu toteuttaa tietokantataulu
ina, mutta näin ei päätetty tehdä.
 Tässä perustellaan, että miksi.
\end_layout

\begin_layout Itemize

\emph on
Käyttäjä: 
\emph default
Monimutkaisemmassa foorumitoteutuksessa käyttäjä olisi ollut ilmeinen tietokanta
taulu.
 Kuitenkin, koska käyttäjästä halutaan tallentaa vain nimimerkki, päätin
 että on yksinkertaisempaa tallentaa tieto viestien kirjoittajista pelkästään
 viestien ja keskustelunavauksien attribuuttina.
\end_layout

\begin_layout Itemize

\emph on
Vastaus: 
\emph default
Olisi ollut myös toteuttaa erillinen vastaus-taulu jolloin viesti-taulun
 olisi voinut jättää pois.
 Päätin olla tekemättä näin, koska monissa foorumin keskeisissä toiminnoissa
 (esimerkiksi uusimman viestin näyttäminen, viestien määrän laskeminen...)
 sekä keskustelunavaukset että vastaukset voidaan laskea viesteiksi, ja
 näin toteutettuna tietokantakyselyistä saadaan sekä yksinkertaisempia että
 nopeampia.
 Valinnan haittapuolena tosin on se, että avauksen luonnin yhteydessä tietoja
 joudutaan tallentamaan useampaan erilliseen tauluun.
\end_layout

\begin_layout Subsection
Käsitekaavio
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename kasite.png

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Käsitekaavio, jossa kuvataan tietokantataulujen yhteydet
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
Tietokannan toteutus
\end_layout

\begin_layout Subsection
Tietokantataulujen luonti
\end_layout

\begin_layout Standard
Foorumin tietokantataulut luodaan seuraavanlaisilla SQL-komennoilla:
\end_layout

\begin_layout Standard

\emph on
Aihealue:
\end_layout

\begin_layout Standard
\begin_inset listings
inline false
status open

\begin_layout Plain Layout

CREATE TABLE Aihealue (
\end_layout

\begin_layout Plain Layout

	id integer PRIMARY KEY,
\end_layout

\begin_layout Plain Layout

    nimi varchar(200)  
\end_layout

\begin_layout Plain Layout

)
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Kuten nähdään, Aihealueeseen liittyen tallennetaan vain nimi ja id-tunniste.
 Myös nimeä olisi periaatteessa ollut mahdollista käyttää pääavaimena, mutta
 tällöin aihealueiden uudelleennimeäminen jälkikäteen olisi hankalampaa.
 Id-sarakkeessa käytetään SQliten automaattista numeroinitia.
\end_layout

\begin_layout Standard

\emph on
Viesti:
\end_layout

\begin_layout Standard
\begin_inset listings
inline false
status open

\begin_layout Plain Layout

CREATE TABLE Viesti (
\end_layout

\begin_layout Plain Layout

	id integer PRIMARY KEY,
\end_layout

\begin_layout Plain Layout

	kirjoittaja varchar(200),
\end_layout

\begin_layout Plain Layout

	sisalto varchar(10000),
\end_layout

\begin_layout Plain Layout

	paivays timestamp,
\end_layout

\begin_layout Plain Layout

	avaus integer,
\end_layout

\begin_layout Plain Layout

	FOREIGN KEY(avaus) REFERENCES Keskustelunavaus(id)
\end_layout

\begin_layout Plain Layout

)
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Viestiin liittyen tallenamme viestin kirjoittajan nimen, viestin sisällön
 (isommalla merkkimäärärajoitteella), viestin päiväyksen ja viitteen keskustelun
avaukseen.
\end_layout

\begin_layout Standard

\emph on
Keskustelunavaus:
\end_layout

\begin_layout Standard
\begin_inset listings
inline false
status open

\begin_layout Plain Layout

CREATE TABLE Keskustelunavaus (
\end_layout

\begin_layout Plain Layout

	id integer PRIMARY KEY,
\end_layout

\begin_layout Plain Layout

	otsikko varchar(200),
\end_layout

\begin_layout Plain Layout

	paivays timestamp,
\end_layout

\begin_layout Plain Layout

	kirjoittaja varchar(200)
\end_layout

\begin_layout Plain Layout

	alue integer,
\end_layout

\begin_layout Plain Layout

	FOREIGN KEY(alue) REFERENCES Aihealue(id),
\end_layout

\begin_layout Plain Layout

) 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Keskustelunavauksesta tallennamme viestin otsikon, kirjoitustiedot, sekä
 viitteen aihealueeseen.
 Huomattavaa on myös hieman epäelegantti ratkaisu, jossa päiväys ja viestin
 kirjoittaja tallennataan toisteisesti, vaikka ne olisikin löydettävissä
 myös avausviestistä (esimerkiksi katsomalla aiheen vanhimman viestin tiedot).
 Päädyin tähän ratkaisuun ennen kaikkea keskeisten tietokantakyselyiden
 yksinkertaistamiseksi.
 Lisäksi voidaan huomioda, että viestien ja avauksien tekijää ja kirjoituspäiväm
äärää ei tarvitse muokata juuri koskaan, eli ratkaisun aiheuttama ylläpidollinen
 lisävaiva on hyvin pieni.
\end_layout

\begin_layout Subsection
Tietokantakaavio
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status collapsed

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout
\begin_inset Graphics
	filename tietokanta.png

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Keskustelupalstan tietokantakaavio.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Section
Keskeisiä käyttötapauksia
\end_layout

\begin_layout Standard
Kaikkien tiettyyn keskustelunavaukseen liittyvien viestien listaaminen (esimerki
ksi kun klikataan keskusteluavauksen linkkiä):
\end_layout

\begin_layout Standard
\begin_inset listings
inline false
status open

\begin_layout Plain Layout

SELECT * FROM Viesti,
\end_layout

\begin_layout Plain Layout

WHERE avaus = xxx
\end_layout

\begin_layout Plain Layout

ORDER BY paivays ASC
\end_layout

\begin_layout Plain Layout

LIMIT 20 OFFSET 0
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Oletetaan että vanhin viesti (avaus) näkyy ensin.
 Esimerkkikomennolla näytettäisiin ensimmäiset 20 viestiä, mutta parametrejä
 LIMIT ja OFFSET voitaisiin muokata näytettävien viestin määrää ja näytettävää
 
\begin_inset Quotes sld
\end_inset

sivua
\begin_inset Quotes srd
\end_inset

 (jos ajatellaan esimerkiksi että viestit 1-20 on sivulla 1, 21-40 sivulla
 2 jne).
 Avausta haetaan pelkällä id-numerolla, koska avauksen nimeä ei tarvitse
 tietää joka viestin yhteydessä ja näin vältytään hitaammalta useamman taulun
 haulta, mutta tarvittaessa taulun nimi saadaan selville joko erillisellä
 kyselyllä tai samassa kyselyssä tekemällä liitos Keskustelunavaus-tauluun.
\end_layout

\begin_layout Standard
Seuraava komento järjestää tietyn aihealueen avaukset järjestykseen, palauttaen
 tiedot viestin lukumäärästä ja viimeisimmän viestin päiväyksestä.
 Tätä voidaan käyttää aihealuenäkymän luomisessa, jossa järjestetään keskustelua
lueet niiden uusimman viestin mukaan:
\end_layout

\begin_layout Standard
\begin_inset listings
inline false
status open

\begin_layout Plain Layout

SELECT k.otsikko, k.id, COUNT(*) as viesteja, MAX(v.paivays) as paivays
\end_layout

\begin_layout Plain Layout

FROM Keskustelunavaus k, Viesti v
\end_layout

\begin_layout Plain Layout

WHERE v.avaus = k.id
\end_layout

\begin_layout Plain Layout

AND k.id = XXX
\end_layout

\begin_layout Plain Layout

GROUP BY k.otsikko, k.id
\end_layout

\begin_layout Plain Layout

ORDER BY paivays DESC
\end_layout

\begin_layout Plain Layout

LIMIT 10 OFFSET 0
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Komento toimii niin, että ensin etsitään kunkin aihealueen uusimman viestin
 päiväys, ja yhdistetään tämä keskustelunavaukseen.
 Sitten yhdistetään mukaan viimeisimmän viestin tiedot.
 Mukana on hieman kankeahko group by-ryhmittely siltä varalta, että johonkin
 aihealueeseen olisi tullut useampi viesti samalta käyttäjältä tiettynä
 ajankohtana.
 Lopussa taas valitaan ensimmäiset 20 arvoa, voidaan muuttaa tarvittaessa.
\end_layout

\begin_layout Standard
Käsitellään vielä kysely jolla saadaan aihealueet järjestettyä samalla tavalla
 viimeisimmän viestin mukaan:
\end_layout

\begin_layout Standard
\begin_inset listings
inline false
status open

\begin_layout Plain Layout

SELECT a.nimi, a.id, COUNT(*) as viesteja, MAX(v.paivays) as paivays
\end_layout

\begin_layout Plain Layout

FROM Keskustelunavaus k, Viesti v, Aihealue a
\end_layout

\begin_layout Plain Layout

WHERE v.avaus = k.id
\end_layout

\begin_layout Plain Layout

AND a.id = k.alue
\end_layout

\begin_layout Plain Layout

GROUP BY a.nimi, a.id
\end_layout

\begin_layout Plain Layout

ORDER BY a.nimi ASC
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Kysely on hyvin samankaltainen edellisen kyselyn kanssa, tosin joudumme
 hakemaan nyt tiedot kolmen taulun yhdistelmästä.
 Järjestelyperusteeksi on vaihdettu alueiden nimi.
\end_layout

\end_body
\end_document
