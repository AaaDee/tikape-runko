Pragma Foreign_keys = ON;

CREATE TABLE Aihealue (
id integer PRIMARY KEY,
nimi varchar(200) 
);

CREATE TABLE Keskustelunavaus (
id integer PRIMARY KEY,
otsikko varchar(200),
paivays datetime,
kirjoittaja varchar(200),
alue integer,
FOREIGN KEY(alue) REFERENCES Aihealue(id)
) ;

CREATE TABLE Viesti (
id integer PRIMARY KEY,
kirjoittaja varchar(200),
sisalto varchar(10000),
paivays datetime,
avaus integer,
FOREIGN KEY(avaus) REFERENCES Keskustelunavaus(id)
);

INSERT Into AIHEALUE (nimi) VALUES ('kissat');
INSERT Into AIHEALUE (nimi) VALUES ('koirat');
INSERT Into AIHEALUE (nimi) VALUES ('autot');

Insert into keskustelunavaus (otsikko, paivays, kirjoittaja, alue) Values
('autojee',datetime('now'),'pasi',1);

Insert into keskustelunavaus (otsikko, paivays, kirjoittaja, alue) Values
('kissajee',datetime('now'),'timo',2);

Insert into keskustelunavaus (otsikko, paivays, kirjoittaja, alue) Values
('koirajee',datetime('now'),'pasi',3);

Insert into Viesti (kirjoittaja, sisalto, paivays, avaus) Values
('pasi', 'eka', datetime('now'),1); 

Insert into Viesti (kirjoittaja, sisalto, paivays, avaus) Values
('pasi', 'toka', datetime('now'),2);

Insert into Viesti (kirjoittaja, sisalto, paivays, avaus) Values
('pasi', 'kolmas', datetime('now'),3); 


SELECT a.nimi, a.id, COUNT(*) as viesteja, MAX(v.paivays) as paivays
FROM Keskustelunavaus k, Viesti v, Aihealue a
WHERE v.avaus = k.id
AND a.id = k.alue
GROUP BY a.nimi, a.id
ORDER BY a.nimi ASC;

